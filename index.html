<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enviar Grupo</title>
  <style>
    body {font-family: Arial; background:#f5f5f5; margin:0; padding:20px;}
    .form {background:white; padding:20px; border-radius:8px; max-width:400px; margin:auto;}
    input, select, button {width:100%; padding:10px; margin:8px 0; border-radius:5px; border:1px solid #ccc;}
    button {background:#25d366; color:white; cursor:pointer;}
    .msg {text-align:center; margin-top:10px;}
    .sidebar {background:#fff; padding:15px; margin-top:30px; border-radius:8px; max-width:400px; margin:auto;}
    .group {border-bottom:1px solid #ccc; padding:5px 0;}
  </style>
</head>
<body>
  <div class="form">
    <h2>Enviar Grupo</h2>
    <input id="nome" placeholder="Nome do grupo">
    <select id="tipo">
      <option value="whatsapp">WhatsApp</option>
      <option value="telegram">Telegram</option>
    </select>
    <input id="link" placeholder="Link do grupo">
    <button id="enviar">Enviar</button>
    <div class="msg" id="msg"></div>
  </div>

  <div class="sidebar" id="aprovados">
    <h3>Grupos Aprovados</h3>
  </div>

  <script>
    const URL = 'https://aqyaxfrukssndxgctukf.supabase.co';
    const KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFxeWF4ZnJ1a3NzbmR4Z2N0dWtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMDY0MTYsImV4cCI6MjA3Nzg4MjQxNn0.fqP4BfoGBr-A8piJevWto3DnJByYvLxB9gudq81KvJw'; // coloque aqui a anon key da Supabase

    async function verificarDuplicado(nome, link) {
      const res = await fetch(`${URL}/rest/v1/grupos?or=(nome.eq.${encodeURIComponent(nome)},link.eq.${encodeURIComponent(link)})&select=id`, {
        headers: { apikey: KEY, Authorization: `Bearer ${KEY}` }
      });
      const data = await res.json();
      return data.length > 0;
    }

    async function enviar() {
      const nome = document.getElementById('nome').value.trim();
      const tipo = document.getElementById('tipo').value;
      const link = document.getElementById('link').value.trim();
      const msg = document.getElementById('msg');

      if (!nome || !link) {
        msg.textContent = "Preencha todos os campos.";
        msg.style.color = "red";
        return;
      }

      if (tipo === "whatsapp" && !link.startsWith("https://chat.whatsapp.com/")) {
        msg.textContent = "Link de WhatsApp inválido.";
        msg.style.color = "red";
        return;
      }

      if (tipo === "telegram" && !link.startsWith("https://t.me/")) {
        msg.textContent = "Link de Telegram inválido.";
        msg.style.color = "red";
        return;
      }

      const duplicado = await verificarDuplicado(nome, link);
      if (duplicado) {
        msg.textContent = "Nome ou link já cadastrado.";
        msg.style.color = "red";
        return;
      }

      const res = await fetch(`${URL}/rest/v1/grupos`, {
        method: 'POST',
        headers: {
          apikey: KEY,
          Authorization: `Bearer ${KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ nome, link, tipo, aprovado: false })
      });

      if (res.ok) {
        msg.textContent = "Grupo enviado para aprovação!";
        msg.style.color = "green";
        document.getElementById('nome').value = '';
        document.getElementById('link').value = '';
        carregarAprovados();
      } else {
        msg.textContent = "Erro ao enviar.";
        msg.style.color = "red";
      }
    }

    async function carregarAprovados() {
      const res = await fetch(`${URL}/rest/v1/grupos?aprovado=eq.true&select=nome,link,tipo`, {
        headers: { apikey: KEY, Authorization: `Bearer ${KEY}` }
      });
      const data = await res.json();
      const box = document.getElementById('aprovados');
      box.innerHTML = '<h3>Grupos Aprovados</h3>' + (data.length ? data.map(g =>
        `<div class="group">
          <b>${g.nome}</b> (${g.tipo})<br>
          <a href="${g.link}" target="_blank">Entrar</a>
        </div>`
      ).join('') : "<p>Nenhum grupo aprovado ainda.</p>");
    }

    document.getElementById('enviar').onclick = enviar;
    carregarAprovados();
  </script>
</body>
</html>
